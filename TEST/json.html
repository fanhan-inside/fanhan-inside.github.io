<!DOCTYPE html>
<html>

<head>
    <meta type="text/html" lang="zh" charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="../main.css" />
    <title>“活人还能被尿憋死不成？”（续）</title>
    <style type="text/css">
        #code,
        #path {
            font-family: var(--font-family-mono);
        }
        #input {
            width: 640px;
            height: 360px;
            font-size: 2rem;
            display: inline-block;
            vertical-align: middle;
        }
        button {
            display: inline-block;
            vertical-align: middle;
            font-size: 3rem;
        }
    </style>
    <script src="../LIB/pouchdb/pouchdb.min.js"></script>
    <script src="../LIB/pouchdb/pouchdb.load.min.js"></script>
    <script src="../LIB/pouchdb/pouchdb.find.min.js"></script>
    <script>
        const mapKana = new Map([
            ["お", "o"],
            ["オ", "o"],
            ["こ", "ko"],
            ["コ", "ko"],
            ["そ", "so"],
            ["ソ", "so"],
            ["と", "to"],
            ["ト", "to"],
            ["の", "no"],
            ["ノ", "no"],
            ["ほ", "ho"],
            ["ホ", "ho"],
            ["も", "mo"],
            ["モ", "mo"],
            ["よ", "yo"],
            ["ヨ", "yo"],
            ["ろ", "ro"],
            ["ロ", "ro"],
            ["を", "wo"],
            ["ヲ", "wo"],
            ["え", "e"],
            ["エ", "e"],
            ["け", "ke"],
            ["ケ", "ke"],
            ["せ", "se"],
            ["セ", "se"],
            ["て", "te"],
            ["テ", "te"],
            ["ね", "ne"],
            ["ネ", "ne"],
            ["へ", "he"],
            ["ヘ", "he"],
            ["め", "me"],
            ["メ", "me"],
            ["れ", "re"],
            ["レ", "re"],
            ["ゑ", "we"],
            ["ヱ", "we"],
            ["う", "u"],
            ["ウ", "u"],
            ["く", "ku"],
            ["ク", "ku"],
            ["す", "su"],
            ["ス", "su"],
            ["つ", "tu"],
            ["ツ", "tu"],
            ["ぬ", "nu"],
            ["ヌ", "nu"],
            ["ふ", "hu"],
            ["フ", "hu"],
            ["む", "mu"],
            ["ム", "mu"],
            ["ゆ", "yu"],
            ["ユ", "yu"],
            ["る", "ru"],
            ["ル", "ru"],
            ["き", "ki"],
            ["キ", "ki"],
            ["し", "si"],
            ["シ", "si"],
            ["ち", "ti"],
            ["チ", "ti"],
            ["に", "ni"],
            ["ニ", "ni"],
            ["ひ", "hi"],
            ["ヒ", "hi"],
            ["み", "mi"],
            ["ミ", "mi"],
            ["り", "ri"],
            ["リ", "ri"],
            ["ゐ", "wi"],
            ["ヰ", "wi"],
            ["あ", "a"],
            ["ア", "a"],
            ["か", "ka"],
            ["カ", "ka"],
            ["さ", "sa"],
            ["サ", "sa"],
            ["た", "ta"],
            ["タ", "ta"],
            ["な", "na"],
            ["ナ", "na"],
            ["は", "ha"],
            ["ハ", "ha"],
            ["ま", "ma"],
            ["マ", "ma"],
            ["や", "ya"],
            ["ヤ", "ya"],
            ["ら", "ra"],
            ["ラ", "ra"],
            ["わ", "wa"],
            ["ワ", "wa"],
            ["い", "i"],
            ["イ", "i"],
            ["ぁ", "a"],
            ["ァ", "a"],
            ["ぃ", "i"],
            ["ィ", "i"],
            ["ぅ", "u"],
            ["ゥ", "u"],
            ["ぇ", "e"],
            ["ェ", "e"],
            ["ぉ", "o"],
            ["ォ", "o"],
            ["ゃ", "ya"],
            ["ャ", "ya"],
            ["ゅ", "yu"],
            ["ュ", "yu"],
            ["ょ", "yo"],
            ["ョ", "yo"],
            ["ゎ", "wa"],
            ["ヮ", "wa"],
            ["っ", "'"],
            ["ッ", "'"],
            ["、", ","],
            ["。", "."],
            ["「", "["],
            ["」", "]"],
            ["：", ":"],
            ["　", " "]
        ]);
        const mapPath = new Map();
        const dbCoin = new PouchDB("tritcoin");
        const dbKana = new PouchDB("hanakana");

        console.log("加载JSON数据……")
        dbCoin.load('../DB/TritCoin.dump').then(function () {
            console.log("加载「三镚子经」完毕");
        }).catch(function (err) {
            console.log("加载「三镚子经」失败：" + err);
        });
        dbKana.load('../DB/hanakana.dump').then(function () {
            console.log("加载「洟仮名」完毕");
        }).catch(function (err) {
            console.log("加载「洟仮名」失败：" + err);
        });

        function transform(str) {
            let arr = [];
            for (let i = 0; i < str.length; i++) {
                let ch = str.charAt(i);
                if (mapKana.has(ch)) {
                    ch = mapKana.get(ch);
                    arr.push(ch);
                    Array.from(ch).forEach(c => {
                        dbKana.find({
                            selector: { trans: c }
                        }).then(function (result) {
                            if (result.docs.length > 0) {
                                mapPath.set(c, result.docs[0]["path"]);
                            }
                        }).catch(function (err) {
                            console.log(err);
                        });
                    });
                }
            }
            return arr.join("");
        }

        function 查询并显示() {
            let id = document.getElementById("上").value + "~" + document.getElementById("中").value + "~" + document.getElementById("下").value;
            console.log("查询「" + id + "」……");
            dbCoin.get(id).then(function (doc) {
                document.getElementById("code").innerText = doc["code"];
                document.getElementById("path").innerText = doc["path"];
                console.log("完毕");
            }).catch(function (err) {
                console.log(err);
            });
        }

        function 查询并替换() {
            let input = document.getElementById("input").value;
            console.log("查询「" + input + "」……");
            document.getElementById("romaji").innerText = transform(input);
            console.log("完毕");
        }
    </script>
</head>

<body>
    <header>
        <h1>“活人还能被尿憋死不成？”（续）</h1>
        <h2 class="remark">以三镚子经为例测试JavaScript/JSON/PouchDB/SVG的浏览器应用</h2>
        <figure style="float: right; border: 2px darkgray dashed;">
            <img src="../DATA/20210716-001_Visual-Acuity.png" />
            <figcaption><span>对数视力表</span></figcaption>
        </figure>
    </header>
    <main>
        <h2 class="heading">三镚子经</h2>
        <div id="输入">
            <span>&emsp;
                <select id="上">
                    <option value="0"></option>
                    <option value="1">一上</option>
                    <option value="2">二上</option>
                    <option value="3">三上</option>
                    <option value="4">四上</option>
                </select>
                <select id="中">
                    <option value="0"></option>
                    <option value="1">一中</option>
                    <option value="2">二中</option>
                    <option value="3">三中</option>
                    <option value="4">四中</option>
                </select>
                <select id="下">
                    <option value="0"></option>
                    <option value="1">一下</option>
                    <option value="2">二下</option>
                    <option value="3">三下</option>
                    <option value="4">四下</option>
                </select>&emsp;
            </span>
            <button onclick="查询并显示()">查询并显示</button>
        </div>
        <p>镚符：<span id="code"></span></p>
        <p>路径：<span id="path"></span></p>

        <h2 class="heading"><ruby lang="ja">洟仮名<rt>ハナカナ</rt></ruby></h2>
        <h3 class="heading"><span>素材：<a target="_blank" href="https://www.omniglot.com/conscripts/hanakana.htm">Hanákana</a></span></h3>
        <p>主页：<a target="_blank" href="https://github.com/mountbuild/tone-script">tone-script</a></p>
        <p>许可：<a target="_blank" href="http://www.apache.org/licenses/">Apache License Version 2.0, January 2004</a></p>
        <h3 class="heading"><span>实践</span></h3>
        <textarea id="input" placeholder="仮名入力" lang="ja"></textarea>
        <button onclick="查询并替换()">查询并替换</button>
        <p>转写：<span id="romaji"></span></p>
    </main>
    <footer>
        <hr />
        <p>参考：</p>
        <ul>
            <li><a class="alone" target="_blank" href="../essay/000_excursus/000-005.html">三镚子经与卡壳牌</a></li>
            <li><a class="alone" target="_blank" href="../at_douban/diary/20210622-001.html">“活人还能被尿憋死不成？”</a></li>
        </ul>
    </footer>
</body>

</html>